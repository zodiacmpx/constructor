<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitor en L√≠nea ‚Äî Builder (Corregido V2)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

  <style>
    :root{
      --bg:#f3f5f8;
      --panel:#ffffff;
      --ink:#1a2433;
      --muted:#6b778c;
      --line:#d9e0ea;
      --brand:#4b2fbf;
      --shadow: 0 6px 18px rgba(18, 38, 63, .08);
      --radius:14px;

      --gap: 12px;

      /* grid math */
      --cols: 12;       
      --row: 48px;      
      --gridPad: 12px; 
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    .topbar{
      background:var(--panel);
      border-bottom:1px solid var(--line);
      padding:18px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      position:sticky;
      top:0;
      z-index:1000;
    }
    .topbar .title{
      font-weight:800;
      color:#0e4aa3;
      letter-spacing:.2px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      color:var(--brand);
      user-select:none;
    }
    .brand .mark{
      width:28px;height:28px;
      border-radius:10px;
      background:linear-gradient(135deg, var(--brand), #7c5cff);
      box-shadow: var(--shadow);
    }

    .toolbar{
      padding:14px 22px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--ink);
      padding:9px 12px;
      border-radius:10px;
      cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:700;
    }
    .btn.primary{
      background:var(--brand);
      color:#fff;
      border-color:transparent;
    }
    .btn.danger{
      background:#ef4444;
      color:#fff;
      border-color:transparent;
    }
    .btn:active{ transform:translateY(1px); }
    .select, .input{
      border:1px solid var(--line);
      background:var(--panel);
      padding:9px 10px;
      border-radius:10px;
      font-weight:700;
      color:var(--ink);
      outline:none;
      min-width:220px;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      margin-left:auto;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .chip{
      border:1px dashed var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      white-space:nowrap;
    }

    .canvas{ padding:0 22px 28px; }

    .section{
      background:transparent;
      margin:14px 0 18px;
    }

    .section-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:10px 0;
      gap:10px;
    }
    .section-header h2{
      margin:0;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:.9px;
      color:#3b4a63;
    }
    .section-header-left{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .section-actions{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .muted{ color:var(--muted); font-weight:700; }

    /* Add menu */
    .add-wrap{ position:relative; display:inline-block; }
    .add-menu{
      position:absolute; top:44px; left:0; width:220px;
      background:#fff; border:1px solid var(--line); border-radius:12px;
      box-shadow: var(--shadow); padding:8px; display:none; z-index:2000;
    }
    .add-menu.open{ display:block; }
    .menu-item{
      width:100%; border:1px solid transparent; background:#fff;
      padding:10px 10px; border-radius:10px; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
      font-weight:800; color:#22304a;
    }
    .menu-item:hover{ background:#f6f8fc; border-color:#eef2ff; }
    .menu-desc{ font-size:12px; color:var(--muted); font-weight:700; margin-left:10px; }

    /* Grid */
    .grid{
      position:relative;
      width:100%;
      display:grid;
      gap: var(--gap);
      align-content:start;
      padding: var(--gridPad);
      background:rgba(255,255,255,.35);
      border:1px solid var(--line);
      border-radius: var(--radius);
      /* IMPORTANTE: Evita overflow visible pero permite resize handles */
      overflow:visible; 

      grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
      grid-auto-rows: var(--row);
    }

    /* Module */
    .module{
      position:relative;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      user-select:none;
      min-width: 100px; 
      min-height: 100px;
      
      /* Touch action crucial para drag en movil/touch */
      touch-action: none; 
      
      z-index: 10;
    }

    /* Estados de interacci√≥n */
    .module:hover { z-index: 20; border-color:#b8c2d3; }
    .module.is-dragging { 
      z-index: 100 !important; 
      opacity: 0.9; 
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    }
    .module.is-resizing {
      z-index: 100 !important;
      opacity: 0.9;
    }
    .module.selected{
      outline:3px solid rgba(75,47,191,.25);
      border-color: rgba(75,47,191,.45);
      z-index: 30;
    }

    .module .mod-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, #ffffff, #fbfcff);
      cursor:grab;
      
      /* IMPORTANTE para el drag handle */
      touch-action: none;
    }
    .module .mod-top:active { cursor: grabbing; }

    .module .mod-title{
      font-size:13px; font-weight:900; color:#22304a;
      display:flex; gap:10px; align-items:center;
      pointer-events: none; /* Dejar pasar clic al padre */
    }
    .badge{
      font-size:11px; font-weight:900; padding:3px 8px;
      border-radius:999px; background:#eef2ff; color:var(--brand);
      border:1px solid #dfe4ff;
    }
    .module .mod-actions{
      display:flex; gap:6px; align-items:center;
    }
    .icon-btn{
      border:1px solid var(--line); background:#fff;
      width:28px; height:28px; border-radius:9px; cursor:pointer;
      display:grid; place-items:center; font-weight:900; color:#3b4a63;
      pointer-events: auto; /* Restaurar clicks */
    }
    .icon-btn:hover{ background:#f6f8fc; }

    .module .mod-body{
      padding:12px;
      height: calc(100% - 44px);
      display:flex; gap:12px; align-items:center; justify-content:center;
      overflow:hidden;
    }

    /* Metric styles */
    .metric{
      width:100%; height:100%; display:flex; flex-direction:column;
      align-items:center; justify-content:center; gap:8px; text-align:center;
    }
    .metric .big{
      font-size:42px; font-weight:1000; letter-spacing:.2px;
      color:#0d3b8f; line-height:1;
    }
    .metric .label{
      font-size:12px; color:var(--muted); font-weight:800;
      text-transform:uppercase; letter-spacing:.8px;
    }
    .metric .sub{ font-size:12px; color:#2b3a55; font-weight:800; }

    /* Chart */
    .chart-wrap{ width:100%; height:100%; padding:6px; position:relative; }
    canvas{ width:100% !important; height:100% !important; }

    /* Status */
    .status{
      width:100%; display:flex; flex-direction:column; gap:10px; padding:6px 8px;
    }
    .status .score{ font-size:38px; font-weight:1000; color:#111827; }
    .status .desc{ font-size:12px; color:var(--muted); font-weight:800; line-height:1.35; }
    .bar{
      width:100%; height:10px; border-radius:999px;
      background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444);
      border:1px solid var(--line); position:relative;
    }
    .bar .pin{
      height:100%; width:12px; border-radius:999px; background:#111827;
      position:absolute; top:0; left:0;
    }

    /* Resize handle - muy importante el z-index */
    .resize-handle{
      position:absolute;
      right:6px; bottom:6px;
      width:16px; height:16px;
      border-right:4px solid #b8c2d3;
      border-bottom:4px solid #b8c2d3;
      border-radius:2px;
      cursor:nwse-resize;
      z-index: 50; 
      touch-action: none;
    }
    .resize-handle:hover { border-color: var(--brand); }

    @media (max-width: 1200px){ :root{ --row: 52px; } .hint{ display:none; } }
    @media (max-width: 900px){ :root{ --row: 56px; --cols: 6; } .select, .input{ min-width:160px; } }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="title">Monitor Builder</div>
    <div class="brand"><div class="mark"></div>saesa</div>
  </div>

  <div class="toolbar">
    <button class="btn primary" id="btnAddSection">‚ûï Secci√≥n</button>

    <select class="select" id="sectionSelect"></select>
    <input class="input" id="sectionName" placeholder="Renombrar secci√≥n..." />
    <button class="btn" id="btnRenameSection">‚úèÔ∏è Renombrar</button>
    <button class="btn danger" id="btnDeleteSection">üóëÔ∏è Borrar secci√≥n</button>

    <span style="width:18px;"></span>

    <button class="btn" id="btnDuplicate">üìÑ Duplicar</button>
    <button class="btn danger" id="btnDeleteModule">üóëÔ∏è Borrar m√≥dulo</button>

    <button class="btn" id="btnReset">‚ôªÔ∏è Reset</button>
    <button class="btn" id="btnExport">‚¨áÔ∏è JSON</button>
    <label class="btn">
      ‚¨ÜÔ∏è Import
      <input type="file" id="importFile" accept="application/json" style="display:none;">
    </label>

    <div class="hint">
      <div class="chip">Arrastra desde el t√≠tulo</div>
      <div class="chip">Esquina inf-der para redimensionar</div>
    </div>
  </div>

  <div class="canvas" id="canvas"></div>

<script>
/* ------------------------------ State ------------------------------ */

const STORAGE_KEY = "saesa_monitor_fixed_final";
let state = { version: 3, sections: [], selected: { sectionId: null, moduleId: null } };
const charts = new Map();
const uid = () => Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(2, 6);

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw) { try { state = JSON.parse(raw); } catch {} }
  if(!state.sections || state.sections.length === 0){ state = demoState(); save(); }
  if(!state.selected) state.selected = { sectionId: state.sections[0]?.id, moduleId: null };
}

function demoState(){
  const s1 = { id: uid(), name:"Recursos", modules:[] };
  const s2 = { id: uid(), name:"Operaciones", modules:[] };

  const mod = (type, title, x, y, w, h, extra={}) => ({
    id: uid(), type, title, x, y, w, h,
    config: { ...defaultConfig(type), ...extra }
  });

  s1.modules.push(
    mod("pie", "Brigadas activas", 1, 1, 3, 6, { data:{ labels:["Jefe","Turno","Guardia","Apoyo"], values:[80,30,40,15] } }),
    mod("card","Documentos despachados", 4, 1, 2, 6, { metric:{ value:"180", label:"Despachados", sub:"Hoy" } }),
    mod("card","Productividad", 6, 1, 3, 6, { metric:{ value:"98%", label:"Global", sub:"Semana" }, bigColor:"#0f9a5f" }),
    mod("status","Complejidad", 1, 7, 5, 5, { status:{ score:7.2, desc:"Nivel de riesgo operativo alto", pin:0.7 } })
  );

  s2.modules.push(
    mod("bar","Fallas por zona", 1, 1, 6, 6, { data:{ labels:["Norte","Sur","Este","Oeste"], values:[12,45,22,8] } }),
    mod("card","Tiempo Respuesta", 7, 1, 4, 4, { metric:{ value:"45m", label:"Promedio" } })
  );

  return { version:3, sections:[s1,s2], selected:{ sectionId:s1.id, moduleId:null } };
}

function defaultConfig(type){
  switch(type){
    case "card": return { metric:{ value:"0", label:"Label", sub:"" }, bigColor:null };
    case "pie":  return { data:{ labels:["A","B","C"], values:[30,50,20] }, legend:true };
    case "bar":  return { data:{ labels:["A","B","C"], values:[10,40,20] }, horizontal:false };
    case "status": return { status:{ score:5.0, desc:"Descripci√≥n...", pin:0.5 } };
    default: return {};
  }
}

/* ------------------------------ Render ----------------------------- */

const elCanvas = document.getElementById("canvas");
const elSectionSelect = document.getElementById("sectionSelect");
const elSectionName = document.getElementById("sectionName");

function render(){
  // 1. Setup Select
  elSectionSelect.innerHTML = "";
  state.sections.forEach(sec=>{
    const opt = document.createElement("option");
    opt.value = sec.id; opt.textContent = sec.name;
    elSectionSelect.appendChild(opt);
  });
  elSectionSelect.value = state.selected.sectionId ?? "";

  // 2. Render Canvas
  elCanvas.innerHTML = "";
  state.sections.forEach(sec=>{
    const sectionDiv = document.createElement("div");
    sectionDiv.className = "section";
    
    // Header
    const header = document.createElement("div");
    header.className = "section-header";
    header.innerHTML = `
      <div class="section-header-left">
        <h2>${escapeHtml(sec.name)}</h2>
        <div class="add-wrap">
          <button class="btn primary" onclick="toggleAddMenu('${sec.id}')">‚ûï</button>
          <div class="add-menu" id="addmenu_${sec.id}">
            <div class="menu-item" onclick="addModule('card','${sec.id}')">üìå Tarjeta</div>
            <div class="menu-item" onclick="addModule('pie','${sec.id}')">ü•ß Circular</div>
            <div class="menu-item" onclick="addModule('bar','${sec.id}')">üìä Barras</div>
            <div class="menu-item" onclick="addModule('status','${sec.id}')">üüß Estado</div>
          </div>
        </div>
        <button class="btn" onclick="renameSection('${sec.id}')">‚úèÔ∏è</button>
        <button class="btn danger" onclick="deleteSection('${sec.id}')">üóëÔ∏è</button>
      </div>
    `;
    sectionDiv.appendChild(header);

    // Grid
    const grid = document.createElement("div");
    grid.className = "grid";
    grid.dataset.sectionId = sec.id; // Necesario para calcular posici√≥n

    sec.modules.forEach(m => {
      const el = document.createElement("div");
      el.className = "module";
      if(state.selected.moduleId === m.id) el.classList.add("selected");
      
      el.dataset.mid = m.id;
      el.dataset.sid = sec.id;

      // CSS Grid Positioning
      el.style.gridColumnStart = m.x;
      el.style.gridColumnEnd = `span ${m.w}`;
      el.style.gridRowStart = m.y;
      el.style.gridRowEnd = `span ${m.h}`;

      el.innerHTML = `
        <div class="mod-top">
          <div class="mod-title">
            <span class="badge">${m.type.toUpperCase()}</span>
            <span>${escapeHtml(m.title)}</span>
          </div>
          <div class="mod-actions">
            <button class="icon-btn" onclick="handleEdit(event, '${sec.id}', '${m.id}')">‚úé</button>
            <button class="icon-btn" onclick="handleDelete(event, '${sec.id}', '${m.id}')">üóë</button>
          </div>
        </div>
        <div class="mod-body">${getModuleBody(m)}</div>
        <div class="resize-handle"></div>
      `;

      // Selecci√≥n al hacer click
      el.addEventListener("mousedown", (e) => {
        // Evitar seleccionar si clicamos un bot√≥n
        if(e.target.closest("button")) return;
        if(state.selected.moduleId !== m.id){
          state.selected.sectionId = sec.id;
          state.selected.moduleId = m.id;
          save();
          // No llamamos render() completo aqu√≠ para no cortar animaciones, solo actualizamos clases
          document.querySelectorAll('.module').forEach(x => x.classList.remove('selected'));
          el.classList.add('selected');
        }
      });

      grid.appendChild(el);

      // ---------------------------------------------------------
      // MAGIA: Inicializar Interact JS *para cada elemento*
      // ---------------------------------------------------------
      makeInteractive(el);
    });

    sectionDiv.appendChild(grid);
    elCanvas.appendChild(sectionDiv);
  });

  rebuildCharts();
}

/* ------------------------- INTERACT JS LOGIC ----------------------- */

function makeInteractive(element) {
  interact(element)
    .draggable({
      // Solo arrastrar desde el encabezado (.mod-top)
      allowFrom: '.mod-top',
      // IMPORTANTE: Ignorar los botones dentro del header para que no inicien arrastre
      ignoreFrom: 'button', 
      
      inertia: true,
      modifiers: [
        interact.modifiers.restrictRect({
          restriction: 'parent', // Restringir al grid
          endOnly: true
        })
      ],
      autoScroll: true, // Permitir scroll si arrastramos al borde

      listeners: {
        start(event) {
          event.target.classList.add('is-dragging');
        },
        move(event) {
          const target = event.target;
          // Guardamos posici√≥n temporal en data attributes
          const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
          const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

          // Aplicar transformaci√≥n visual
          target.style.transform = `translate(${x}px, ${y}px)`;
          target.setAttribute('data-x', x);
          target.setAttribute('data-y', y);
        },
        end(event) {
          event.target.classList.remove('is-dragging');
          // Calcular d√≥nde cay√≥ en la grilla
          snapToGrid(event.target);
        }
      }
    })
    .resizable({
      // Habilitar resize
      edges: { left: false, right: '.resize-handle', bottom: '.resize-handle', top: false },
      
      modifiers: [
        // Tama√±o m√≠nimo
        interact.modifiers.restrictSize({
          min: { width: 140, height: 100 }
        }),
        interact.modifiers.restrictEdges({
          outer: 'parent'
        })
      ],

      listeners: {
        start(event) {
            event.target.classList.add('is-resizing');
        },
        move(event) {
          const target = event.target;
          let x = (parseFloat(target.getAttribute('data-x')) || 0);
          let y = (parseFloat(target.getAttribute('data-y')) || 0);

          // Actualizar tama√±o visualmente
          target.style.width = event.rect.width + 'px';
          target.style.height = event.rect.height + 'px';

          // Si redimensionamos a la izquierda (no habilitado aqu√≠ pero por seguridad)
          x += event.deltaRect.left;
          y += event.deltaRect.top;

          target.style.transform = `translate(${x}px, ${y}px)`;
          target.setAttribute('data-x', x);
          target.setAttribute('data-y', y);
        },
        end(event) {
            event.target.classList.remove('is-resizing');
            snapToGrid(event.target, true);
        }
      }
    });
}

// Funci√≥n que traduce pixeles a columnas/filas de CSS Grid
function snapToGrid(element, isResize = false) {
    const mid = element.dataset.mid;
    const sid = element.dataset.sid;
    const sec = state.sections.find(s => s.id === sid);
    const mod = sec.modules.find(m => m.id === mid);
    
    if(!mod) return;

    // Obtener m√©tricas de la grilla
    const gridEl = element.parentElement;
    const gridRect = gridEl.getBoundingClientRect();
    const elRect = element.getBoundingClientRect();
    
    // Variables CSS
    const style = getComputedStyle(document.documentElement);
    const cols = parseInt(style.getPropertyValue('--cols')) || 12;
    const gap = parseInt(style.getPropertyValue('--gap').replace('px','')) || 12;
    const rowH = parseInt(style.getPropertyValue('--row').replace('px','')) || 48;
    const padding = 12; // gridPad

    // Ancho √∫til de una columna
    const totalGap = (cols - 1) * gap;
    const usableWidth = gridRect.width - (padding * 2) - totalGap;
    const colWidth = usableWidth / cols;

    // Calcular Posici√≥n (X, Y)
    // Distancia desde el inicio del grid (quitando padding)
    const relativeX = elRect.left - gridRect.left - padding;
    const relativeY = elRect.top - gridRect.top - padding;

    // Traducir a indices (base 1)
    let colIndex = Math.round(relativeX / (colWidth + gap)) + 1;
    let rowIndex = Math.round(relativeY / (rowH + gap)) + 1;

    // Validar l√≠mites
    colIndex = Math.max(1, Math.min(colIndex, cols));
    rowIndex = Math.max(1, rowIndex);

    mod.x = colIndex;
    mod.y = rowIndex;

    // Calcular Dimensiones (W, H)
    if(isResize) {
        // Ancho en columas
        let wSpan = Math.round(elRect.width / (colWidth + gap));
        let hSpan = Math.round(elRect.height / (rowH + gap));
        
        mod.w = Math.max(1, Math.min(wSpan, cols - mod.x + 1));
        mod.h = Math.max(1, hSpan);
    } else {
        // Si solo movemos, asegurar que no se salga a la derecha
        if(mod.x + mod.w - 1 > cols) {
            mod.x = cols - mod.w + 1;
        }
    }

    // Limpiar estilos inline sucios de interact.js
    element.style.transform = '';
    element.removeAttribute('data-x');
    element.removeAttribute('data-y');
    element.style.width = '';
    element.style.height = '';

    // Guardar y renderizar para "bloquear" en la grilla
    save();
    render(); 
}


/* ----------------------- Module Helpers --------------------------- */

function getModuleBody(m){
  if(m.type === "card"){
    const metric = m.config.metric;
    return `
      <div class="metric">
        <div class="big" style="color:${m.config.bigColor||''};">${escapeHtml(metric.value)}</div>
        <div class="label">${escapeHtml(metric.label)}</div>
        <div class="sub">${escapeHtml(metric.sub)}</div>
      </div>
    `;
  }
  if(m.type === "status"){
    const st = m.config.status;
    const p = Math.min(1, Math.max(0, st.pin));
    return `
      <div class="status">
        <div class="score">${st.score}</div>
        <div class="desc">${escapeHtml(st.desc)}</div>
        <div class="bar"><div class="pin" style="left:${p*100}%"></div></div>
      </div>
    `;
  }
  return `<div class="chart-wrap"><canvas id="c_${m.id}"></canvas></div>`;
}

function handleEdit(e, sid, mid){
  e.stopPropagation(); // Stop click bubbling
  const sec = state.sections.find(s=>s.id===sid);
  const m = sec.modules.find(x=>x.id===mid);
  
  const title = prompt("T√≠tulo:", m.title);
  if(title) m.title = title;

  // L√≥gica simplificada de edici√≥n
  if(m.type==="card"){
    const v = prompt("Valor:", m.config.metric.value);
    if(v) m.config.metric.value = v;
  }
  save(); render();
}

function handleDelete(e, sid, mid){
  e.stopPropagation();
  if(!confirm("¬øBorrar?")) return;
  const sec = state.sections.find(s=>s.id===sid);
  sec.modules = sec.modules.filter(x=>x.id!==mid);
  if(charts.has(mid)) { charts.get(mid).destroy(); charts.delete(mid); }
  save(); render();
}

/* ------------------------- Charts & Utils ------------------------ */

function rebuildCharts(){
  // Limpiar charts viejos
  const currentIds = [];
  state.sections.forEach(s=>s.modules.forEach(m=>currentIds.push(m.id)));
  
  for(const [id, chart] of charts.entries()){
    if(!currentIds.includes(id)) { chart.destroy(); charts.delete(id); }
  }

  // Crear nuevos
  state.sections.forEach(sec=>{
    sec.modules.forEach(m=>{
      if(m.type!=="pie" && m.type!=="bar") return;
      const ctx = document.getElementById(`c_${m.id}`);
      if(!ctx) return;
      
      if(charts.has(m.id)){ charts.get(m.id).destroy(); }

      const cfg = {
        type: m.type,
        data: {
          labels: m.config.data.labels,
          datasets:[{ data: m.config.data.values, backgroundColor:['#4b2fbf','#7c5cff','#eef2ff','#1a2433'] }]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display: m.type==="pie", position:'bottom' } }
        }
      };
      if(m.type==="bar") cfg.options.indexAxis = m.config.horizontal?'y':'x';

      charts.set(m.id, new Chart(ctx, cfg));
    });
  });
}

/* ----------------------- Global Actions -------------------------- */

function escapeHtml(text) {
  if(!text) return "";
  return text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

/* Menus */
window.toggleAddMenu = (sid) => {
  document.querySelectorAll('.add-menu').forEach(e=>e.classList.remove('open'));
  document.getElementById(`addmenu_${sid}`).classList.add('open');
};
window.addModule = (type, sid) => {
  const sec = state.sections.find(s=>s.id===sid);
  // Buscar primera fila libre simple
  let maxY = 0; sec.modules.forEach(m=> maxY = Math.max(maxY, m.y+m.h));
  
  sec.modules.push({
    id: uid(), type, title: type.toUpperCase(),
    x: 1, y: maxY?maxY:1, w: 4, h: 5,
    config: defaultConfig(type)
  });
  save(); render();
};
window.renameSection = (sid) => {
  const s = state.sections.find(x=>x.id===sid);
  const n = prompt("Nombre:", s.name);
  if(n) { s.name=n; save(); render(); }
};
window.deleteSection = (sid) => {
  if(!confirm("¬øBorrar secci√≥n?")) return;
  state.sections = state.sections.filter(x=>x.id!==sid);
  save(); render();
};
document.onclick = (e) => {
  if(!e.target.closest('.add-wrap')) document.querySelectorAll('.add-menu').forEach(x=>x.classList.remove('open'));
};

/* Start */
load();
render();

</script>
</body>
</html>
