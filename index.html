<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitor en L√≠nea ‚Äî Builder (Fix definitivo v5)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

  <style>
    :root{
      --bg:#f3f5f8;
      --panel:#ffffff;
      --ink:#1a2433;
      --muted:#6b778c;
      --line:#d9e0ea;
      --brand:#4b2fbf;
      --shadow: 0 6px 18px rgba(18, 38, 63, .08);
      --radius:14px;

      --gap: 12px;
      --cols: 12;
      --row: 48px;
      --gridPad: 12px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    .topbar{
      background:var(--panel);
      border-bottom:1px solid var(--line);
      padding:18px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      position:sticky;
      top:0;
      z-index:50;
    }
    .topbar .title{
      font-weight:800;
      color:#0e4aa3;
      letter-spacing:.2px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      color:var(--brand);
      user-select:none;
    }
    .brand .mark{
      width:28px;height:28px;
      border-radius:10px;
      background:linear-gradient(135deg, var(--brand), #7c5cff);
      box-shadow: var(--shadow);
    }

    .toolbar{
      padding:14px 22px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--ink);
      padding:9px 12px;
      border-radius:10px;
      cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:700;
    }
    .btn.primary{
      background:var(--brand);
      color:#fff;
      border-color:transparent;
    }
    .btn.danger{
      background:#ef4444;
      color:#fff;
      border-color:transparent;
    }
    .btn:active{ transform:translateY(1px); }

    .select, .input{
      border:1px solid var(--line);
      background:var(--panel);
      padding:9px 10px;
      border-radius:10px;
      font-weight:700;
      color:var(--ink);
      outline:none;
      min-width:220px;
    }

    .hint{
      color:var(--muted);
      font-size:12px;
      margin-left:auto;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .chip{
      border:1px dashed var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      white-space:nowrap;
    }

    .canvas{ padding:0 22px 28px; }

    .section{ margin:14px 0 18px; }
    .section-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:10px 0;
      gap:10px;
    }
    .section-header-left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .section-header h2{
      margin:0;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:.9px;
      color:#3b4a63;
    }
    .section-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .muted{ color:var(--muted); font-weight:700; }

    .add-wrap{ position:relative; display:inline-block; }
    .add-menu{
      position:absolute;
      top:44px;
      left:0;
      width:220px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      box-shadow: var(--shadow);
      padding:8px;
      display:none;
      z-index:60;
    }
    .add-menu.open{ display:block; }
    .menu-item{
      width:100%;
      border:1px solid transparent;
      background:#fff;
      padding:10px 10px;
      border-radius:10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:800;
      color:#22304a;
    }
    .menu-item:hover{
      background:#f6f8fc;
      border-color:#eef2ff;
    }
    .menu-desc{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      margin-left:10px;
    }

    /* GRID: contenedor relativo para m√≥dulos absolutos */
    .grid{
      position:relative;
      width:100%;
      padding: var(--gridPad);
      background:rgba(255,255,255,.35);
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      min-height: calc(var(--row) * 8);
    }

    /* MODULE: absoluto */
    .module{
      position:absolute;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      user-select:none;
      min-width: 140px;
      z-index: 1;

      touch-action: none;
      transition: box-shadow 0.2s, z-index 0s;
    }

    .module:hover {
      z-index: 10;
      box-shadow: 0 8px 24px rgba(18, 38, 63, .12);
    }
    .module.is-dragging {
      z-index: 100 !important;
      opacity: 0.96;
      box-shadow: 0 12px 30px rgba(75, 47, 191, .2);
    }
    .module.selected{
      outline:3px solid rgba(75,47,191,.25);
      border-color: rgba(75,47,191,.45);
      z-index: 20;
    }

    .module.is-locked .mod-top{ cursor:not-allowed; }
    .module.is-locked .mod-body{ cursor:default; }
    .module.is-locked .resize-handle{ opacity:0; pointer-events:none; }

    .module .mod-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, #ffffff, #fbfcff);
      cursor:grab;
      position:relative;
      z-index: 2;
    }

    .module .mod-title{
      font-size:13px;
      font-weight:900;
      color:#22304a;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .badge{
      font-size:11px;
      font-weight:900;
      padding:3px 8px;
      border-radius:999px;
      background:#eef2ff;
      color:var(--brand);
      border:1px solid #dfe4ff;
    }
    .module .mod-actions{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .icon-btn{
      border:1px solid var(--line);
      background:#fff;
      width:28px;height:28px;
      border-radius:9px;
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight:900;
      color:#3b4a63;
    }
    .icon-btn:hover{ background:#f6f8fc; }

    .module .mod-body{
      padding:12px;
      height: calc(100% - 44px);
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
    }

    .metric{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      text-align:center;
    }
    .metric .big{
      font-size:42px;
      font-weight:1000;
      letter-spacing:.2px;
      color:#0d3b8f;
      line-height:1;
    }
    .metric .label{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.8px;
    }
    .metric .sub{
      font-size:12px;
      color:#2b3a55;
      font-weight:800;
    }

    .chart-wrap{ width:100%; height:100%; padding:6px 6px 2px; }
    canvas{ width:100% !important; height:100% !important; }

    .status{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:6px 8px;
    }
    .status .score{
      font-size:38px;
      font-weight:1000;
      color:#111827;
    }
    .status .desc{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      line-height:1.35;
    }
    .bar{
      width:100%;
      height:10px;
      border-radius:999px;
      background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444);
      border:1px solid var(--line);
      position:relative;
    }
    .bar .pin{
      height:100%;
      width:12px;
      border-radius:999px;
      background:#111827;
      position:absolute;
      top:0;
      left:0;
      transform: translateX(0);
    }

    .resize-handle{
      position:absolute;
      right:8px;
      bottom:8px;
      width:16px;
      height:16px;
      border-right:3px solid #b8c2d3;
      border-bottom:3px solid #b8c2d3;
      border-radius:2px;
      opacity:.9;
      pointer-events:auto;
      cursor:se-resize;
      z-index:3;
    }

    @media (max-width: 1200px){
      :root{ --row: 52px; }
      .hint{ display:none; }
    }
    @media (max-width: 900px){
      :root{ --row: 56px; --cols: 6; }
      .select, .input{ min-width:160px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="title">Monitor en L√≠nea</div>
    <div class="brand"><div class="mark"></div>grupo saesa</div>
  </div>

  <div class="toolbar">
    <button class="btn primary" id="btnAddSection">‚ûï Secci√≥n</button>

    <select class="select" id="sectionSelect" title="Secci√≥n activa (acciones globales)"></select>
    <input class="input" id="sectionName" placeholder="Renombrar secci√≥n..." />
    <button class="btn" id="btnRenameSection">‚úèÔ∏è Renombrar</button>
    <button class="btn danger" id="btnDeleteSection">üóëÔ∏è Borrar secci√≥n</button>

    <span style="width:18px;"></span>

    <button class="btn" id="btnDuplicate">üìÑ Duplicar m√≥dulo</button>
    <button class="btn danger" id="btnDeleteModule">üóëÔ∏è Borrar m√≥dulo</button>

    <button class="btn" id="btnReset">‚ôªÔ∏è Reset demo</button>
    <button class="btn" id="btnExport">‚¨áÔ∏è Export JSON</button>
    <label class="btn">
      ‚¨ÜÔ∏è Import JSON
      <input type="file" id="importFile" accept="application/json" style="display:none;">
    </label>

    <div class="hint">
      <div class="chip">Desbloquea üîì para mover/redimensionar</div>
      <div class="chip">Arrastra desde cualquier parte (no botones)</div>
      <div class="chip">Redimensiona desde bordes o esquina</div>
    </div>
  </div>

  <div class="canvas" id="canvas"></div>

<script>
/* ------------------------------ State ------------------------------ */

const STORAGE_KEY = "saesa_monitor_builder_v4_absolute"; // puedes cambiarla si quieres reset total
let state = { version: 5, sections: [], selected: { sectionId: null, moduleId: null } };
const charts = new Map();

const uid = () => Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(2, 6);
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try { state = JSON.parse(raw); } catch {}
  }
  if(!state.sections || state.sections.length === 0){
    state = demoState();
    save();
  }
  state.sections.forEach(sec=>{
    sec.modules.forEach(m=>{
      if(typeof m.locked !== "boolean") m.locked = true;
    });
  });
  if(!state.selected) state.selected = { sectionId: state.sections[0]?.id ?? null, moduleId: null };
  if(!state.selected.sectionId && state.sections[0]) state.selected.sectionId = state.sections[0].id;
}

function demoState(){
  const s1 = { id: uid(), name:"Recursos", modules:[] };
  const s2 = { id: uid(), name:"Tiempos", modules:[] };
  const s3 = { id: uid(), name:"Requerimientos", modules:[] };

  const mod = (type, title, x, y, w, h, extra={}) => ({
    id: uid(), type, title, x, y, w, h,
    locked: true,
    config: { ...defaultConfig(type), ...extra }
  });

  s1.modules.push(
    mod("pie", "Brigadas activas", 1, 1, 3, 6, { data:{ labels:["Jefe de Faena","Jefe Turno","Guardia SAE","Apoyo Contingencia","Otras"], values:[883,313,414,175,92] } }),
    mod("card","Documentos despachados", 4, 1, 2, 6, { metric:{ value:"180", label:"Documentos despachados", sub:"Hoy" } }),
    mod("pie", "Disponibilidad de brigadas", 6, 1, 3, 6, { data:{ labels:["En turno","Por terminar turno","En pausa","Fuera de turno"], values:[1712,3074,420,380] } }),
    mod("card","Productividad (%)", 1, 7, 5, 6, { metric:{ value:"120%", label:"Productividad", sub:"(Ejemplo)" }, bigColor:"#0f9a5f" }),
    mod("status","Complejidad operacional", 6, 7, 4, 6, { status:{ score:9.5, desc:"(tareas activas + fallas nuevas) / brigadas disponibles\nVerde <4 ¬∑ Amarillo 4‚Äì6 ¬∑ Rojo >6", pin:0.72 } })
  );

  s2.modules.push(
    mod("card","Tiempo medio de asignaci√≥n de brigada", 1, 1, 4, 5, { metric:{ value:"01:15:27", label:"Asignaci√≥n brigada" } }),
    mod("card","Tiempo de concurrencia a falla", 5, 1, 4, 5, { metric:{ value:"02:47:51", label:"Concurrencia a falla" } }),
    mod("card","Tiempo medio de espera", 9, 1, 4, 5, { metric:{ value:"03:14:22", label:"Espera" } }),
    mod("bar","Cantidad de PT por Tipo", 1, 6, 7, 6, { data:{ labels:["Tipo A","Tipo B","Tipo C","Tipo D","Acotadas"], values:[377,24,4,1,3] } }),
    mod("card","Complejidad PT", 8, 6, 5, 6, { metric:{ value:"ALTO", label:"Complejidad PT", sub:"(Ejemplo)" }, bigColor:"#111827" })
  );

  s3.modules.push(
    mod("bar","Concurrencia ante fallas (hoy)", 1, 1, 6, 6, { data:{ labels:["Dentro","Fuera"], values:[94,9] } }),
    mod("pie","Documentos abiertos", 7, 1, 5, 6, { data:{ labels:["Arribado","Despachado","Asignado","En bandeja"], values:[319,102,260,38] } }),
    mod("bar","Tareas del d√≠a", 1, 7, 7, 6, { data:{ labels:["Ejecutadas","En ejecuci√≥n","Asignadas"], values:[82,56,125] } }),
    mod("card","Efectividad de despacho", 8, 7, 4, 3, { metric:{ value:"0.89%", label:"Efectividad de despacho" } }),
    mod("card","Ocupaci√≥n Brigada", 8, 10, 4, 3, { metric:{ value:"80%", label:"Ocupaci√≥n Brigada" } })
  );

  return { version:5, sections:[s1,s2,s3], selected:{ sectionId:s1.id, moduleId:null } };
}

function defaultConfig(type){
  switch(type){
    case "card": return { metric:{ value:"0", label:"T√≠tulo", sub:"" }, bigColor:null };
    case "pie":  return { data:{ labels:["A","B","C"], values:[10,20,30] }, legend:true };
    case "bar":  return { data:{ labels:["A","B","C"], values:[10,20,30] }, horizontal:false };
    case "status": return { status:{ score:5.0, desc:"Descripci√≥n‚Ä¶", pin:0.5 } };
    default: return {};
  }
}

/* ------------------------------ Render ----------------------------- */

const elCanvas = document.getElementById("canvas");
const elSectionSelect = document.getElementById("sectionSelect");
const elSectionName = document.getElementById("sectionName");

let rafToken = 0;

function render(){
  // selector global
  elSectionSelect.innerHTML = "";
  state.sections.forEach(sec=>{
    const opt = document.createElement("option");
    opt.value = sec.id;
    opt.textContent = sec.name;
    elSectionSelect.appendChild(opt);
  });
  elSectionSelect.value = state.selected.sectionId ?? state.sections[0]?.id ?? "";

  // canvas
  elCanvas.innerHTML = "";

  // vamos a colocar m√≥dulos DESPU√âS de montar el DOM
  const placements = [];

  state.sections.forEach(sec=>{
    const section = document.createElement("div");
    section.className = "section";
    section.dataset.sectionId = sec.id;

    const header = document.createElement("div");
    header.className = "section-header";
    header.innerHTML = `
      <div class="section-header-left">
        <h2>${escapeHtml(sec.name)}</h2>

        <div class="add-wrap">
          <button class="btn primary" data-action="toggle-add" data-section="${sec.id}">‚ûï</button>
          <div class="add-menu" id="addmenu_${sec.id}">
            <button class="menu-item" data-add="card" data-section="${sec.id}">üìå Tarjeta <span class="menu-desc">KPI / n√∫mero</span></button>
            <button class="menu-item" data-add="pie" data-section="${sec.id}">ü•ß Circular <span class="menu-desc">distribuci√≥n</span></button>
            <button class="menu-item" data-add="bar" data-section="${sec.id}">üìä Barras <span class="menu-desc">comparaci√≥n</span></button>
            <button class="menu-item" data-add="status" data-section="${sec.id}">üüß Estado <span class="menu-desc">score / regla</span></button>
          </div>
        </div>

        <button class="btn" data-action="rename-section" data-section="${sec.id}">‚úèÔ∏è Renombrar</button>
        <button class="btn danger" data-action="delete-section" data-section="${sec.id}">üóëÔ∏è Borrar</button>
      </div>
      <div class="section-actions">
        <span class="muted">ID:</span>
        <span class="muted" style="font-family:ui-monospace, SFMono-Regular, Menlo, monospace;">${sec.id}</span>
      </div>
    `;
    section.appendChild(header);

    const grid = document.createElement("div");
    grid.className = "grid";
    grid.dataset.sectionId = sec.id;
    section.appendChild(grid);

    elCanvas.appendChild(section);

    sec.modules.forEach(m=>{
      const modEl = document.createElement("div");
      modEl.className = "module";
      modEl.dataset.moduleId = m.id;
      modEl.dataset.sectionId = sec.id;

      if(state.selected.moduleId === m.id) modEl.classList.add("selected");
      if(m.locked) modEl.classList.add("is-locked");

      const lockIcon = m.locked ? "üîí" : "üîì";
      const lockTitle = m.locked ? "Desbloquear mover/redimensionar" : "Bloquear mover/redimensionar";

      modEl.innerHTML = `
        <div class="mod-top">
          <div class="mod-title">
            <span class="badge">${m.type.toUpperCase()}</span>
            <span class="t">${escapeHtml(m.title)}</span>
          </div>
          <div class="mod-actions">
            <button class="icon-btn" title="${lockTitle}" data-action="toggle-lock">${lockIcon}</button>
            <button class="icon-btn" title="Editar" data-action="edit">‚úé</button>
            <button class="icon-btn" title="Borrar" data-action="delete">üóë</button>
          </div>
        </div>
        <div class="mod-body">${moduleBodyHTML(m)}</div>
        <div class="resize-handle"></div>
      `;

      modEl.addEventListener("click", (e)=>{
        if(e.target?.closest?.("[data-action]")) return;
        if(state.selected.moduleId === m.id && state.selected.sectionId === sec.id) return;
        select(sec.id, m.id);
      });

      modEl.querySelectorAll("[data-action]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const action = e.currentTarget.dataset.action;
          if(action === "delete") removeModule(sec.id, m.id);
          if(action === "edit") editModule(sec.id, m.id);
          if(action === "toggle-lock") toggleModuleLock(sec.id, m.id);
        });
      });

      grid.appendChild(modEl);
      placements.push({ grid, modEl, m });
    });

    // section header buttons
    header.querySelector('[data-action="toggle-add"]').addEventListener("click", (e)=>{
      e.stopPropagation();
      toggleAddMenu(e.currentTarget.dataset.section);
    });

    header.querySelectorAll("[data-add]").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        addModuleToSection(e.currentTarget.dataset.add, e.currentTarget.dataset.section);
        closeAllAddMenus();
      });
    });

    header.querySelector('[data-action="rename-section"]').addEventListener("click", (e)=>{
      e.stopPropagation();
      renameSection(sec.id);
    });
    header.querySelector('[data-action="delete-section"]').addEventListener("click", (e)=>{
      e.stopPropagation();
      deleteSection(sec.id);
    });
  });

  // 1) Cancelar RAF anterior si hay spam de renders
  if(rafToken) cancelAnimationFrame(rafToken);

  // 2) Esperar al pr√≥ximo frame (grid ya tiene ancho real) -> colocar m√≥dulos
  rafToken = requestAnimationFrame(()=>{
    placements.forEach(p => placeModuleInPixels(p.grid, p.modEl, p.m));
    adjustAllGridHeights();

    // IMPORTANT: bind interact despu√©s de que todo est√° posicionado
    setupInteract();

    // charts despu√©s (tama√±o correcto)
    rebuildCharts();
  });
}

/* ------------------------------ Men√∫s ------------------------------ */

function toggleAddMenu(sectionId){
  state.sections.forEach(s=>{
    if(s.id !== sectionId){
      const el = document.getElementById("addmenu_"+s.id);
      if(el) el.classList.remove("open");
    }
  });
  const menu = document.getElementById("addmenu_"+sectionId);
  if(menu) menu.classList.toggle("open");
}
function closeAllAddMenus(){
  state.sections.forEach(s=>{
    const el = document.getElementById("addmenu_"+s.id);
    if(el) el.classList.remove("open");
  });
}
document.addEventListener("click", (e)=>{
  const isInside = e.target.closest?.(".add-wrap");
  if(!isInside) closeAllAddMenus();
});

/* --------------------------- Module bodies -------------------------- */

function moduleBodyHTML(m){
  if(m.type === "card"){
    const metric = m.config.metric || {};
    const bigStyle = m.config.bigColor ? `style="color:${m.config.bigColor};"` : "";
    return `
      <div class="metric">
        <div class="big" ${bigStyle}>${escapeHtml(String(metric.value ?? ""))}</div>
        <div class="label">${escapeHtml(String(metric.label ?? ""))}</div>
        ${metric.sub ? `<div class="sub">${escapeHtml(String(metric.sub))}</div>` : ""}
      </div>
    `;
  }
  if(m.type === "status"){
    const st = m.config.status || {};
    const pin = clamp01(st.pin ?? 0.5);
    return `
      <div class="status">
        <div class="score">${escapeHtml(String(st.score ?? ""))}</div>
        <div class="desc">${escapeHtml(String(st.desc ?? "")).replaceAll("\n","<br>")}</div>
        <div class="bar"><div class="pin" style="transform: translateX(${Math.round(pin*100)}%);"></div></div>
        <div class="muted">Nivel actual</div>
      </div>
    `;
  }
  return `<div class="chart-wrap"><canvas id="c_${m.id}"></canvas></div>`;
}

/* ------------------------- Global interactions ---------------------- */

function select(sectionId, moduleId){
  state.selected.sectionId = sectionId;
  state.selected.moduleId = moduleId;
  save();
  render();
}

document.getElementById("sectionSelect").addEventListener("change", (e)=>{
  state.selected.sectionId = e.target.value;
  state.selected.moduleId = null;
  save();
  render();
});

document.getElementById("btnAddSection").addEventListener("click", ()=>{
  const name = prompt("Nombre de la nueva secci√≥n:", "Nueva secci√≥n");
  if(!name) return;
  const sec = { id: uid(), name, modules: [] };
  state.sections.push(sec);
  state.selected.sectionId = sec.id;
  state.selected.moduleId = null;
  save();
  render();
});

document.getElementById("btnRenameSection").addEventListener("click", ()=>{
  const sid = state.selected.sectionId;
  if(!sid) return;
  const sec = state.sections.find(s=>s.id===sid);
  if(!sec) return;

  const newName = (elSectionName.value || "").trim() || prompt("Nuevo nombre:", sec.name);
  if(!newName) return;

  sec.name = newName;
  elSectionName.value = "";
  save();
  render();
});

document.getElementById("btnDeleteSection").addEventListener("click", ()=>{
  const sid = state.selected.sectionId;
  if(!sid) return;
  deleteSection(sid);
});

document.getElementById("btnDeleteModule").addEventListener("click", ()=>{
  const sid = state.selected.sectionId;
  const mid = state.selected.moduleId;
  if(!sid || !mid) return alert("Selecciona un m√≥dulo primero.");
  removeModule(sid, mid);
});

document.getElementById("btnDuplicate").addEventListener("click", ()=>{
  const sid = state.selected.sectionId;
  const mid = state.selected.moduleId;
  if(!sid || !mid) return alert("Selecciona un m√≥dulo primero.");

  const sec = state.sections.find(s=>s.id===sid);
  const m = sec?.modules.find(x=>x.id===mid);
  if(!sec || !m) return;

  const copy = structuredClone(m);
  copy.id = uid();
  copy.title = m.title + " (copia)";
  copy.x = clampInt(m.x + 1, 1, colsFromCSS());
  copy.y = m.y + 1;
  sec.modules.push(copy);

  state.selected.moduleId = copy.id;
  save();
  render();
});

document.getElementById("btnReset").addEventListener("click", ()=>{
  const ok = confirm("¬øResetear a la demo inicial? (se perder√°n cambios)");
  if(!ok) return;
  state = demoState();
  save();
  render();
});

document.getElementById("btnExport").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "monitor_builder.json";
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById("importFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const text = await f.text();
    const parsed = JSON.parse(text);
    if(!parsed.sections) throw new Error("JSON inv√°lido (no tiene sections).");
    state = parsed;
    if(!state.selected) state.selected = { sectionId: state.sections[0]?.id ?? null, moduleId: null };
    save();
    render();
  }catch(err){
    alert("No pude importar: " + err.message);
  }finally{
    e.target.value = "";
  }
});

/* ------------------------------ Section ops ------------------------- */

function renameSection(sectionId){
  const sec = state.sections.find(s=>s.id===sectionId);
  if(!sec) return;
  const newName = prompt("Nuevo nombre de secci√≥n:", sec.name);
  if(!newName) return;
  sec.name = newName.trim();
  state.selected.sectionId = sectionId;
  save();
  render();
}

function deleteSection(sectionId){
  const sec = state.sections.find(s=>s.id===sectionId);
  if(!sec) return;
  const ok = confirm(`¬øBorrar secci√≥n "${sec.name}" y todos sus m√≥dulos?`);
  if(!ok) return;

  sec.modules.forEach(m=>{
    if(charts.has(m.id)){
      charts.get(m.id).destroy();
      charts.delete(m.id);
    }
  });

  state.sections = state.sections.filter(s=>s.id!==sectionId);
  state.selected.sectionId = state.sections[0]?.id ?? null;
  state.selected.moduleId = null;
  save();
  render();
}

/* ------------------------------ Modules ---------------------------- */

function addModuleToSection(type, sectionId){
  const sec = state.sections.find(s=>s.id===sectionId);
  if(!sec) return;

  const y = (sec.modules.reduce((max, m)=> Math.max(max, m.y + m.h), 0) || 1);

  const m = {
    id: uid(),
    type,
    title: titleForType(type),
    x: 1,
    y: y,
    w: 4,
    h: (type==="card" ? 5 : 7),
    locked: true,
    config: defaultConfig(type)
  };

  if(type==="card"){
    m.config.metric.value = "0";
    m.config.metric.label = "Nueva tarjeta";
  }
  if(type==="pie" || type==="bar"){
    m.config.data = { labels:["A","B","C"], values:[10,20,30] };
  }
  if(type==="status"){
    m.config.status = { score: 5.0, desc:"Reglas/definici√≥n‚Ä¶", pin: 0.5 };
  }

  sec.modules.push(m);
  state.selected.sectionId = sectionId;
  state.selected.moduleId = m.id;
  save();
  render();
}

function removeModule(sectionId, moduleId){
  const sec = state.sections.find(s=>s.id===sectionId);
  if(!sec) return;
  const m = sec.modules.find(x=>x.id===moduleId);
  if(!m) return;

  const ok = confirm(`¬øBorrar m√≥dulo "${m.title}"?`);
  if(!ok) return;

  if(charts.has(moduleId)){
    charts.get(moduleId).destroy();
    charts.delete(moduleId);
  }

  sec.modules = sec.modules.filter(x=>x.id!==moduleId);
  state.selected.moduleId = null;
  save();
  render();
}

function editModule(sectionId, moduleId){
  const sec = state.sections.find(s=>s.id===sectionId);
  const m = sec?.modules.find(x=>x.id===moduleId);
  if(!m) return;

  const title = prompt("T√≠tulo del m√≥dulo:", m.title);
  if(title !== null && title.trim() !== "") m.title = title.trim();

  if(m.type === "card"){
    const value = prompt("Valor grande (ej: 180, 120%, 02:47:51):", m.config.metric?.value ?? "");
    if(value !== null) m.config.metric.value = value;

    const label = prompt("Etiqueta:", m.config.metric?.label ?? "");
    if(label !== null) m.config.metric.label = label;

    const sub = prompt("Subtexto (opcional):", m.config.metric?.sub ?? "");
    if(sub !== null) m.config.metric.sub = sub;

    const color = prompt("Color del valor (hex o vac√≠o):", m.config.bigColor ?? "");
    if(color !== null) m.config.bigColor = color.trim() || null;
  }

  if(m.type === "pie" || m.type === "bar"){
    const labels = prompt("Labels separados por coma:", (m.config.data?.labels ?? []).join(","));
    if(labels !== null) m.config.data.labels = labels.split(",").map(s=>s.trim()).filter(Boolean);

    const values = prompt("Valores separados por coma:", (m.config.data?.values ?? []).join(","));
    if(values !== null){
      const nums = values.split(",").map(s=>Number(String(s).trim()));
      m.config.data.values = nums.map(n => Number.isFinite(n) ? n : 0);
    }

    if(m.type === "bar"){
      const horiz = confirm("¬øBarras horizontales? (Aceptar = s√≠, Cancelar = no)");
      m.config.horizontal = horiz;
    }
  }

  if(m.type === "status"){
    const score = prompt("Score (n√∫mero):", String(m.config.status?.score ?? 5));
    if(score !== null){
      const n = Number(score);
      if(Number.isFinite(n)) m.config.status.score = n;
    }
    const desc = prompt("Descripci√≥n (usa \\n para saltos):", String(m.config.status?.desc ?? ""));
    if(desc !== null) m.config.status.desc = desc.replaceAll("\\n", "\n");

    const pin = prompt("Pin 0..1 (ej: 0.72):", String(m.config.status?.pin ?? 0.5));
    if(pin !== null){
      const p = Number(pin);
      if(Number.isFinite(p)) m.config.status.pin = clamp01(p);
    }
  }

  save();
  render();
}

function toggleModuleLock(sectionId, moduleId){
  const sec = state.sections.find(s=>s.id===sectionId);
  const m = sec?.modules.find(x=>x.id===moduleId);
  if(!m) return;
  m.locked = !m.locked;
  save();
  render();
}

function titleForType(type){
  if(type==="card") return "Tarjeta";
  if(type==="pie") return "Gr√°fico circular";
  if(type==="bar") return "Gr√°fico de barras";
  if(type==="status") return "Estado / Nivel";
  return "M√≥dulo";
}

/* ---------------------- Pixel placement & snapping ---------------------- */

function getGridMetrics(gridEl){
  const rootStyle = getComputedStyle(document.documentElement);
  const gap  = parsePx(rootStyle.getPropertyValue("--gap"));
  const pad  = parsePx(rootStyle.getPropertyValue("--gridPad"));
  const rowH = parsePx(rootStyle.getPropertyValue("--row"));
  const cols = colsFromCSS();

  const usableW = gridEl.clientWidth - (pad*2);
  const colW = (usableW - (gap * (cols - 1))) / cols;

  const stepX = colW + gap;
  const stepY = rowH + gap;

  return { gap, pad, rowH, cols, colW, stepX, stepY };
}

function placeModuleInPixels(gridEl, moduleEl, m){
  const { gap, pad, colW, rowH, stepX, stepY } = getGridMetrics(gridEl);

  // Seguridad contra widths raros (por si grid est√° oculto)
  if(!Number.isFinite(colW) || colW <= 1){
    moduleEl.style.left = pad + "px";
    moduleEl.style.top  = pad + ((m.y-1) * (rowH + gap)) + "px";
    moduleEl.style.width = "320px";
    moduleEl.style.height = "280px";
    return;
  }

  const left = pad + (m.x - 1) * stepX;
  const top  = pad + (m.y - 1) * stepY;

  const width  = (m.w * colW) + ((m.w - 1) * gap);
  const height = (m.h * rowH) + ((m.h - 1) * gap);

  moduleEl.style.left = left + "px";
  moduleEl.style.top  = top  + "px";
  moduleEl.style.width  = width  + "px";
  moduleEl.style.height = height + "px";
}

function snapPixelsToGrid(gridEl, moduleEl, includeResize){
  const sectionId = moduleEl.dataset.sectionId;
  const moduleId  = moduleEl.dataset.moduleId;
  const sec = state.sections.find(s=>s.id===sectionId);
  const m = sec?.modules.find(x=>x.id===moduleId);
  if(!m) return;

  const { pad, cols, stepX, stepY, gap } = getGridMetrics(gridEl);

  const left = (parsePx(moduleEl.style.left) - pad);
  const top  = (parsePx(moduleEl.style.top)  - pad);

  let newX = clampInt(Math.round(left / stepX) + 1, 1, cols);
  let newY = Math.max(1, Math.round(top / stepY) + 1);

  m.x = newX;
  m.y = newY;

  if(includeResize){
    const wPx = parsePx(moduleEl.style.width);
    const hPx = parsePx(moduleEl.style.height);

    let w = Math.max(1, Math.round((wPx + gap) / stepX));
    let h = Math.max(1, Math.round((hPx + gap) / stepY));

    m.w = clampInt(w, 1, cols);
    m.h = h;
  }

  if(m.x + m.w - 1 > cols){
    m.x = Math.max(1, cols - m.w + 1);
  }
}

/* ---------------------------- Drag/Resize -------------------------- */

function setupInteract(){
  // IMPORTANT: esto evita que queden instancias viejas cuando re-renderizas
  interact(".module").unset();

  interact(".module")
    .draggable({
      // SIN allowFrom: para que funcione en spans/canvas/etc.
      ignoreFrom: ".resize-handle, .icon-btn, .mod-actions, button, input, select, textarea, a",
      inertia: true,
      modifiers: [
        interact.modifiers.restrictRect({
          restriction: "parent",
          endOnly: true
        })
      ],
      listeners: {
        start(event){
          if(isModuleLockedEl(event.target)){
            event.interaction.stop();
            return;
          }
          event.target.classList.add("is-dragging");
        },
        move(event){
          const t = event.target;
          t.style.left = ((parsePx(t.style.left)||0) + event.dx) + "px";
          t.style.top  = ((parsePx(t.style.top)||0)  + event.dy) + "px";
        },
        end(event){
          const t = event.target;
          t.classList.remove("is-dragging");
          const gridEl = t.parentElement;
          if(!gridEl || !gridEl.classList.contains("grid")) return;

          snapPixelsToGrid(gridEl, t, false);
          const sec = state.sections.find(s=>s.id===t.dataset.sectionId);
          const m = sec?.modules.find(x=>x.id===t.dataset.moduleId);
          if(m) placeModuleInPixels(gridEl, t, m);

          save();
          adjustGridHeight(gridEl);
        }
      }
    })
    .resizable({
      edges: { left:true, right:true, bottom:true, top:true },
      inertia: true,
      modifiers: [
        interact.modifiers.restrictEdges({ outer: "parent" }),
        interact.modifiers.restrictSize({ min: { width: 140, height: 140 } })
      ],
      listeners: {
        start(event){
          if(isModuleLockedEl(event.target)){
            event.interaction.stop();
            return;
          }
          event.target.classList.add("is-dragging");
        },
        move(event){
          const t = event.target;

          const newLeft = (parsePx(t.style.left)||0) + event.deltaRect.left;
          const newTop  = (parsePx(t.style.top)||0)  + event.deltaRect.top;

          t.style.left = newLeft + "px";
          t.style.top  = newTop  + "px";
          t.style.width  = event.rect.width + "px";
          t.style.height = event.rect.height + "px";
        },
        end(event){
          const t = event.target;
          t.classList.remove("is-dragging");
          const gridEl = t.parentElement;
          if(!gridEl || !gridEl.classList.contains("grid")) return;

          snapPixelsToGrid(gridEl, t, true);
          const sec = state.sections.find(s=>s.id===t.dataset.sectionId);
          const m = sec?.modules.find(x=>x.id===t.dataset.moduleId);
          if(m) placeModuleInPixels(gridEl, t, m);

          save();
          adjustGridHeight(gridEl);

          // Re-render para refrescar charts al nuevo tama√±o
          render();
        }
      }
    });
}

/* ------------------------------ Charts ----------------------------- */

function rebuildCharts(){
  const allModuleIds = new Set();
  state.sections.forEach(s=>s.modules.forEach(m=>allModuleIds.add(m.id)));

  for(const [mid, chart] of charts.entries()){
    if(!allModuleIds.has(mid)){
      chart.destroy();
      charts.delete(mid);
    }
  }

  state.sections.forEach(sec=>{
    sec.modules.forEach(m=>{
      if(m.type !== "pie" && m.type !== "bar") return;
      const canvas = document.getElementById(`c_${m.id}`);
      if(!canvas) return;

      if(charts.has(m.id)){
        charts.get(m.id).destroy();
        charts.delete(m.id);
      }

      const labels = m.config.data?.labels ?? [];
      const values = m.config.data?.values ?? [];

      const cfg = (m.type === "pie")
        ? {
            type: "pie",
            data: { labels, datasets:[{ data: values }] },
            options: {
              responsive:true,
              maintainAspectRatio:false,
              plugins:{
                legend:{ display: !!m.config.legend, position:"bottom", labels:{ boxWidth:12 } },
              }
            }
          }
        : {
            type: "bar",
            data: { labels, datasets:[{ data: values }] },
            options: {
              responsive:true,
              maintainAspectRatio:false,
              indexAxis: m.config.horizontal ? "y" : "x",
              plugins:{ legend:{ display:false } },
              scales:{
                x:{ grid:{ color:"rgba(0,0,0,.06)" } },
                y:{ grid:{ color:"rgba(0,0,0,.06)" }, beginAtZero:true }
              }
            }
          };

      charts.set(m.id, new Chart(canvas.getContext("2d"), cfg));
    });
  });
}

/* -------------------- Grid height (para que no corte) ------------------- */

function adjustGridHeight(gridEl){
  const sectionId = gridEl.dataset.sectionId;
  const sec = state.sections.find(s=>s.id===sectionId);
  if(!sec) return;

  const rootStyle = getComputedStyle(document.documentElement);
  const gap  = parsePx(rootStyle.getPropertyValue("--gap"));
  const rowH = parsePx(rootStyle.getPropertyValue("--row"));
  const pad  = parsePx(rootStyle.getPropertyValue("--gridPad"));

  const maxRow = sec.modules.reduce((mx, m)=> Math.max(mx, m.y + m.h - 1), 1);
  const height = pad*2 + (maxRow * rowH) + ((maxRow - 1) * gap);

  gridEl.style.minHeight = Math.max(height, rowH * 8) + "px";
}
function adjustAllGridHeights(){
  document.querySelectorAll(".grid").forEach(adjustGridHeight);
}

/* ------------------------------ Utils ------------------------------ */

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function clampInt(x,a,b){ return Math.max(a, Math.min(b, x)); }
function parsePx(v){
  const n = Number(String(v).replace("px","").trim());
  return Number.isFinite(n) ? n : 0;
}
function colsFromCSS(){
  const cols = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--cols")) || 12;
  return cols;
}
function isModuleLockedEl(moduleEl){
  const sectionId = moduleEl.dataset.sectionId;
  const moduleId = moduleEl.dataset.moduleId;
  const sec = state.sections.find(s=>s.id===sectionId);
  const m = sec?.modules.find(x=>x.id===moduleId);
  return !!m?.locked;
}

/* ------------------------------ Boot ------------------------------- */

load();
render();

window.addEventListener("resize", ()=> render());
</script>
</body>
</html>

